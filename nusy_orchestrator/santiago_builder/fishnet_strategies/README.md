# Fishnet v2.0.0 - Multi-Strategy BDD Generation

Fishnet generates Behavior-Driven Development (BDD) test files from extracted PM behavior documentation using pluggable generation strategies.

## Overview

**Version**: 2.0.0  
**Architecture**: [docs/architecture/fishnet-architecture.md](../../../docs/architecture/fishnet-architecture.md)  
**Strategies Implemented**: Bottom-Up (PRIMARY)

## Features

- ✅ Multi-strategy pattern architecture
- ✅ Generates Gherkin .feature files from behavior specifications
- ✅ 3 scenarios per behavior (happy path, edge case, error handling)
- ✅ Provenance tracking in generated files
- ✅ CLI interface with argparse
- ✅ Comprehensive unit test coverage

## Quick Start

### Generate BDD Tests

```bash
python nusy_orchestrator/santiago_builder/fishnet_cli.py \
  --behaviors knowledge/catches/santiago-pm-behaviors/pm-behaviors-extracted.md \
  --ontology knowledge/ontologies/pm-domain-ontology.ttl \
  --output features/santiago-pm-behaviors \
  --strategies bottom_up
```

### Output

Generated 28 .feature files with 84 scenarios (28 behaviors × 3 scenarios each):
- `features/santiago-pm-behaviors/*.feature`

## Architecture

### Strategy Pattern

```
fishnet_strategies/
├── __init__.py               # Package exports
├── base_strategy.py          # Abstract base class + dataclasses
├── bottom_up_strategy.py     # PRIMARY: Generate from behavior docs
├── top_down_strategy.py      # FUTURE: Generate from ontology
├── external_strategy.py      # FUTURE: Generate from research
├── logic_strategy.py         # FUTURE: Generate from logic rules
└── experiment_strategy.py    # FUTURE: Generate experimental tests
```

### Core Classes

#### BehaviorSpec
Represents an extracted PM behavior:
```python
@dataclass
class BehaviorSpec:
    name: str
    description: str
    capability_level: str  # Apprentice, Journeyman, Master, Expert
    knowledge_scope: str   # Pond, Lake, Sea, Ocean
    input_schema: Dict[str, Any]
    output_schema: Dict[str, Any]
    mutates_kg: bool
    concurrency_safe: bool
    ontology_mapping: str
    cli_example: str
    sparql_query: str
```

#### BDDScenario
Represents a single test scenario:
```python
@dataclass
class BDDScenario:
    scenario_name: str
    scenario_type: str  # happy_path, edge_case, error_handling
    given_steps: List[str]
    when_steps: List[str]
    then_steps: List[str]
    strategy_used: str
    tags: List[str]
```

#### BDDFeatureFile
Represents a complete .feature file:
```python
@dataclass
class BDDFeatureFile:
    feature_name: str
    feature_description: str
    background_steps: List[str]
    scenarios: List[BDDScenario]
    tags: List[str]
    behavior_spec: BehaviorSpec
    
    def to_gherkin(self) -> str:
        """Convert to Gherkin format"""
```

## Strategies

### Bottom-Up Strategy (PRIMARY)

**Source**: Extracted behavior markdown files  
**Approach**: Generate scenarios directly from input/output schemas

**Generates**:
1. **Happy Path**: Valid inputs → expected outputs (uses CLI examples)
2. **Edge Case**: Boundary values, optional parameters, minimal inputs
3. **Error Handling**: Invalid/missing required parameters → error responses

**Example Output**:
```gherkin
# Generated by Fishnet v2.0.0
# Strategy: BottomUp
# Source: pm-behaviors-extracted.md
# Behavior: status_query

@apprentice @pond @status_query
Feature: MCP Tool: status_query
  Query artifacts by status, assignee, update date, or artifact type

  Background:
    Given the Santiago PM MCP service is running
    And the knowledge graph is initialized with test data
    And I have Apprentice level permissions

  @happy-path
  Scenario: Successfully execute status_query
    Given the Santiago PM knowledge graph is initialized
    When I invoke the 'status_query' MCP tool
    Then the MCP tool should succeed
    Then the knowledge graph should remain unchanged
```

### Future Strategies

- **Top-Down**: Generate from ontology constraints (PLANNED)
- **External**: Generate from industry best practices (PLANNED)
- **Logic**: Generate from computational logic (PLANNED)
- **Experiment**: Generate experimental tests (PLANNED)

## CLI Usage

### Basic Usage

```bash
python fishnet_cli.py \
  --behaviors <path-to-pm-behaviors-extracted.md> \
  --ontology <path-to-ontology.ttl> \
  --output <output-directory> \
  --strategies bottom_up
```

### Arguments

- `--behaviors` (required): Path to pm-behaviors-extracted.md file
- `--ontology` (required): Path to pm-domain-ontology.ttl file
- `--output` (required): Output directory for .feature files
- `--strategies` (optional): Comma-separated strategy names (default: bottom_up)

### Examples

```bash
# Generate with bottom-up strategy
python fishnet_cli.py \
  --behaviors knowledge/catches/santiago-pm-behaviors/pm-behaviors-extracted.md \
  --ontology knowledge/ontologies/pm-domain-ontology.ttl \
  --output features/tests \
  --strategies bottom_up

# Multiple strategies (when implemented)
python fishnet_cli.py \
  --behaviors pm-behaviors.md \
  --ontology ontology.ttl \
  --output tests/ \
  --strategies bottom_up,top_down
```

## Validation

### Behave Validation

Validate generated files with behave:

```bash
# Create proper structure
mkdir -p bdd-validation/features/steps
cp features/santiago-pm-behaviors/*.feature bdd-validation/features/
touch bdd-validation/features/steps/__init__.py

# Run dry-run validation
cd bdd-validation
behave --dry-run
```

Expected output:
```
28 features parsed
84 scenarios parsed
695 undefined steps (expected - no step definitions yet)
```

## Testing

### Run Unit Tests

```bash
pytest tests/test_fishnet_strategies.py -v
```

### Test Coverage

- ✅ BehaviorSpec creation and validation
- ✅ BDDScenario creation and structure
- ✅ BDDFeatureFile Gherkin generation
- ✅ BottomUpStrategy scenario generation (3 scenarios)
- ✅ Happy path scenario structure
- ✅ Edge case scenario structure
- ✅ Error handling scenario structure
- ✅ Background step generation
- ✅ Feature file generation
- ✅ mutates_kg flag handling
- ✅ Input schema parsing
- ✅ Output schema parsing

**Test Results**: 14/14 tests passing

## Integration

### Programmatic Usage

```python
from pathlib import Path
from nusy_orchestrator.santiago_builder.fishnet import FishnetCLI
from nusy_orchestrator.santiago_builder.fishnet_strategies.bottom_up_strategy import BottomUpStrategy

# Create orchestrator
fishnet = FishnetCLI(
    behaviors_file=Path("pm-behaviors-extracted.md"),
    ontology_file=Path("pm-domain-ontology.ttl"),
    output_dir=Path("bdd-tests/")
)

# Register strategies
fishnet.register_strategy("bottom_up", BottomUpStrategy())

# Generate all BDD files
results = fishnet.generate_all_bdd_files(strategy_names=["bottom_up"])

print(f"Generated {results['files_generated']} files")
print(f"Covering {results['total_behaviors']} behaviors")
```

## File Structure

```
nusy_orchestrator/santiago_builder/
├── fishnet.py                          # Main orchestrator (async + CLI)
├── fishnet_cli.py                      # CLI script
└── fishnet_strategies/
    ├── __init__.py                     # Package exports
    ├── base_strategy.py                # Abstract base + dataclasses
    └── bottom_up_strategy.py           # Bottom-up implementation

tests/
└── test_fishnet_strategies.py          # Unit tests (14 tests)

features/santiago-pm-behaviors/          # Generated .feature files
├── status_query_bottom_up.feature
├── create_feature_bottom_up.feature
└── ... (28 total files)
```

## Acceptance Criteria

- [x] `base_strategy.py` with abstract base class + data classes
- [x] `bottom_up_strategy.py` fully implemented (PRIMARY strategy)
- [x] `fishnet.py` orchestrator loads 28 behaviors and generates 84 files
- [x] CLI works with all arguments
- [x] Unit tests pass (`pytest tests/test_fishnet_strategies.py`) - 14/14 passing
- [x] Output validates: `behave --dry-run` passes (28 features, 84 scenarios)
- [x] Provenance comments in each .feature file

## Future Work

1. Implement remaining strategies:
   - Top-Down (ontology-driven)
   - External (research-driven)
   - Logic (computation-driven)
   - Experiment (unknown resolution)

2. Add multi-strategy composition and validation loops

3. Implement step definitions for behave execution

4. Add coverage analysis and gap detection

## Related Documentation

- [Fishnet Architecture](../../../docs/architecture/fishnet-architecture.md)
- [Cargo Manifest: Fishnet BDD Generation Strategies](../../../santiago-pm/cargo-manifests/fishnet-bdd-generation-strategies.feature.md)
- [PM Behaviors Extracted](../../../knowledge/catches/santiago-pm-behaviors/pm-behaviors-extracted.md)
- [PM Domain Ontology](../../../knowledge/ontologies/pm-domain-ontology.ttl)

## Version History

- **v2.0.0** (2025-11-17): Multi-strategy architecture with bottom-up implementation
- **v1.0.0** (2025-01-16): Initial async implementation in fishnet.py
