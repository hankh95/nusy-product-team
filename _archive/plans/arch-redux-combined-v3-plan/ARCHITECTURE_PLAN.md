# Santiago Factory Architecture Plan

**Prepared by:** Combined Hybrid (Meta-Plan)
**Date:** 2025-11-16
**Version:** 3.0

---

## Executive Summary

Santiago is a self-bootstrapping factory, not a fixed agent team. We start with a "fake team" of thin MCP proxies to external APIs that quickly deliver capability and, crucially, build the factory. The factory (Navigator, Catchfish, Fishnet) catches real, domain-specific Santiagos from authoritative sources in 30–60 minutes per source with 3–5 validation cycles, then progressively replaces proxies via A/B testing at ≥90% parity. Over time, real Santiagos improve the factory itself.

This plan operationalizes the factory pattern: Phase 0 deploys proxy MCP services; Phase 1 implements factory components and validation loops; Phase 2 catches and deploys the first real Santiago (e.g., santiago-pm-safe-xp) and replaces the fake counterpart; Phase 3 repeats per role with progressive replacement; Phase 4 becomes self-sustaining, with real Santiagos proposing and implementing factory improvements under guardrails.

---

## Current Architecture

- `santiago_core/` contains active development for Santiago capabilities and service scaffolding.
- `santiago-code/` and `src/nusy_pm_core/` are archived/legacy references, useful for patterns but not drivers of new design.
- `ocean-research/` holds the key architectural guidance, DGX deployment specs, and multi-agent patterns.
- `santiago-pm/` encodes development patterns as folder structure (expeditions, tackle, voyage-trials, strategic-charts) including the 10-step "Old Man and the Sea" process.
- The critical `knowledge/` layer is currently missing; the factory will create and manage `knowledge/catches/` artifacts and a trust registry.

---

## Target Architecture

### Phase 0: Fake Team (Contractor Proxies)

- Implement thin MCP proxy services in `santiago_core/agents/_proxy/` for roles (PM, Architect, Developer, QA, UX, Platform, Ethicist).
- Each proxy loads role-specific instructions from `knowledge/proxy-instructions/` and routes tool execution to external APIs (e.g., OpenAI, Claude, Copilot) via a unified adapter.
- Purpose: deliver immediate capability and, most importantly, build the factory (Phases 1–2) quickly.

### Phase 1: Factory Components (Built by Fake Team)

- Navigator: orchestrates the 10-step fishing process from "Old Man and the Sea" with 3–5 validation cycles, manages expedition state, and coordinates Catchfish and Fishnet.
- Catchfish: performs 4-layer extraction from sources (raw text → entities/relations → semantic Markdown with YAML frontmatter → knowledge graph). Baseline 30–60 minutes per source; optimization target <15 minutes.
- Fishnet: generates BDD scenarios and MCP capability manifests from the knowledge graph; maintains provenance and coverage mapping. Produces feature files and draft MCP manifests.
- Validation & Provenance: every expedition writes provenance to `knowledge/catches/<santiago>/provenance.yaml` and maintains a trust registry (`knowledge/catches/index.yaml`). KG writes are queued and schema-validated.

### Phase 2: First Catch & Replacement

- Expedition: catch `santiago-pm-safe-xp` from SAFe and XP sources using Navigator+Catchfish+Fishnet.
- Validation: iterate 3–5 cycles until ≥95% BDD pass rate generated by Fishnet; deploy as an MCP service under `santiago_core/agents/santiago-pm-safe-xp/` with an auto-generated `mcp-manifest.json`.
- A/B Testing: run matched PM tasks through Fake PM (proxy) vs Real PM (santiago-pm-safe-xp) on shared DGX-served model; measure quality, latency, and cost.
- Replacement: if Real ≥ 90% quality parity, route PM tasks to Real and retire or sandbox the proxy for fallback.

### Phase 3: Progressive Replacement

- Repeat Phase 2 for Architect, Developer, QA, UX, Platform roles; each replacement is an experiment with explicit hypotheses and acceptance criteria.
- Hybrid period: orchestrator dispatches per-role traffic to the best available Santiago (Real when available, else Proxy), with observability and budget controls.

### Phase 4: Self-Sustaining

- Real Santiagos propose factory improvements (e.g., Catchfish extraction prompts, Fishnet test generation strategies, Navigator heuristics) via guarded RFCs.
- Changes flow through the same validation and A/B process; provenance is updated, ensuring continuous improvement without corrupting the KG.

---

## Key Architectural Components

### Navigator

- Orchestrates the 10-step fishing process (see "Old Man and the Sea"). Manages expedition plans, source acquisition, extraction cycles, test generation, validation, and deployment handoff. Tracks metrics (cycle count, pass rate, time per source).

### Catchfish

- Extracts structured 4-layer knowledge from sources. Targets <15 minutes per source over time. Outputs Markdown with YAML frontmatter, plus edges for the knowledge graph. Feeds Fishnet and the KG write queue.

### Fishnet

- Generates BDD feature files and suggests MCP tool capabilities from the KG, linking tests back to knowledge nodes for traceability. Maintains coverage ratios and proposes new tests for gaps.

### Fake Team Proxies

- Live under `santiago_core/agents/_proxy/`. Provide MCP services that route to external APIs via a unified adapter. Each loads `knowledge/proxy-instructions/<role>.md`.

### Knowledge Storage

- `knowledge/catches/<santiago>/` contains:
  - `domain-knowledge/` (Markdown + YAML frontmatter)
  - `bdd-tests/` (Fishnet-generated feature files)
  - `mcp-manifest.json` (auto-generated)
  - `provenance.yaml` (expedition metadata)
- `knowledge/templates/` provides reusable content skeletons.
- `knowledge/catches/index.yaml` functions as a trust registry with versions, hashes, and validation status.

---

## MCP Integration

- Each real Santiago runs as an independent MCP service with an auto-generated manifest (Fishnet as manifest engine). Discovery reads from the trust registry.
- Coordination Patterns: orchestrator invokes services via MCP; tools are declared in manifests; services communicate through queued requests with backpressure and budget gates.
- Phase 0 proxies implement the same MCP interface, enabling seamless replacement by real Santiagos.

---

## Interfaces & Contracts

- MCP Service Interface: Each Santiago exposes a service interface with declared tools, parameters, and guarantees. Contracts are versioned (e.g., `service.version: 1.0`) and validated via contract tests.
- Manifest Contract: Manifests include identity, tools, rate/budget hints, and capability tags. Fishnet generates drafts; Navigator ensures they satisfy the contract schema.

```json
{
  "service": {
    "id": "santiago-pm-safe-xp",
    "version": "1.0",
    "ttl_seconds": 3600,
    "capabilities": ["planning", "bdd.validate", "kg.query"],
    "budget": {"unit": "usd", "daily_limit": 25.0}
  },
  "tools": [
    {"name": "plan_epic", "inputs": {"goal": "string"}, "returns": {"plan_id": "string"}},
    {"name": "bdd_validate", "inputs": {"feature": "string"}, "returns": {"pass_rate": "number"}}
  ]
}
```

- Acceptance Tests (Contract):
  - Given a valid manifest, the service advertises all tools with correct I/O shapes.
  - When a tool is invoked with schema-valid inputs, it must return schema-valid outputs within SLO latency.
  - When budget is exceeded, service responds with a throttling error and retry-after.

---

## DGX Deployment

- Serve a shared 7–8B instruction model (e.g., Mistral-7B-Instruct) via vLLM or TensorRT-LLM with continuous batching on DGX. Optimize for throughput and latency.
- Observability: Prometheus for metrics, Loki/Grafana for logs and dashboards. Track per-role latency, cost, and quality.
- Memory & Storage: allocate sufficient RAM and NVMe to cache sources, intermediary KG artifacts, and manifests. Use an object store or NVMe-backed cache for large documents.

### SLOs & Budgets

- SLO Targets (per request, steady-state):
  - p95 latency: ≤ 1800 ms (proxy) / ≤ 2500 ms (real, DGX-served)
  - Error rate: ≤ 1%
  - Cost per request: ≤ 0.03 USD (real, DGX-served)
- Throughput: Sustain ≥ 20 RPS aggregate across roles with continuous batching; nominal batch size 8–16.
- Budgets: Per-role daily budgets enforced at orchestrator; default 25 USD/day/role, adjustable via config.
- Dashboards: Latency histograms, throughput, cost-per-request, queue depth, rejection rate, A/B parity trend.

---

## Ethics & Concurrency Gating

- Queue-first tool execution: all KG writes pass through a queue with schema validation, provenance stamping, and trust checks before commit.
- Santiago-Ethicist proxy/service: pre-execution review for risky actions and post-execution audits. Escalate to human-in-the-loop for flagged items.
- Concurrency control: per-entity locks in the KG write pipeline; budget gates and rate limiting at orchestrator; A/B gates require ≥90% parity before replacement; rehearsal gates require ≥95% BDD pass before deploy.

### KG Write Queue Contract

- Event Schema (write-intent):

```yaml
schema_version: 1
event_id: uuid
entity_key: "knowledge:catches:santiago-pm-safe-xp:node-123"
operation: upsert # or delete
author: { type: "santiago", id: "santiago-pm-safe-xp@1.0" }
provenance_ref: "knowledge/catches/santiago-pm-safe-xp/provenance.yaml#2025-11-16T12:34:56Z"
diff: { before: {}, after: { title: "XP Pairing", links: ["..."] } }
approvals: ["ethicist@1.0"]
idempotency_key: "sha256:..."
```

- Guarantees:
  - Per-entity locks (advisory) to serialize writes by `entity_key`.
  - Idempotent processing via `idempotency_key`.
  - Schema validation before commit; on failure, write is rejected with actionable diagnostics.

---

## Provenance & Trust Registry

- Trust Registry File: `knowledge/catches/index.yaml` consolidates all caught Santiagos and their validation status.

```yaml
schema_version: 1
catches:
  - id: santiago-pm-safe-xp
    version: 1.0.0
    hash: "sha256:..."
    sources:
      - ocean-research/dgx_spark_nusy_report.md
      - ocean-research/nusy_manolin_architecture.md
    bdd_pass_rate: 0.96
    replacement:
      proxy: santiago-pm-proxy@1.0
      decision: approved
      rationale: ">=90% A/B parity across 15 tasks"
    provenance: knowledge/catches/santiago-pm-safe-xp/provenance.yaml
    signed_by: copilot@2025-11-16
    timestamp: 2025-11-16T16:45:00Z
```

- Registry Guarantees:
  - Every deployed real Santiago has an entry with version, hash, pass rate, and replacement decision.
  - Orchestrator consults the registry to route traffic and enforce fallbacks.

---

## References Cited

- ocean-research/00-ARCHITECTURE-PATTERN.md
- santiago-pm/strategic-charts/Old man and the sea.md
- ocean-research/building-on-DGX/dgx_spark_nusy_report.md
- ocean-research/dgx_spark_nusy_report.md
- ocean-research/nusy_manolin_architecture.md
- ocean-research/nusy_manolin_provisioning_automation.md
- ocean-research/nusy_manolin_multi_agent_test_plans.md
- ocean-research/fake_team_feature_plan.md
- ocean-research/fake_team_steps_for_hank_and_copilot.md
- nusy_prototype/ (clinical prototype evidence: 30–60m per source, 3 validation cycles)
- santiago-pm/expeditions/
- santiago-pm/tackle/
- santiago-pm/voyage-trials/
