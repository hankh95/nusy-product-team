name: Lint

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Compute changed markdown files (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        id: md_changed
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"
          git fetch --no-tags --prune --depth=1 origin "$BASE_SHA" || true
          mapfile -t FILES < <(git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- '**/*.md')
          if (( ${#FILES[@]} == 0 )); then
            echo "has_md_changes=false" >> "$GITHUB_OUTPUT"
            printf "files=\n" >> "$GITHUB_OUTPUT"
          else
            echo "has_md_changes=true" >> "$GITHUB_OUTPUT"
            printf "files=%s\n" "${FILES[*]}" >> "$GITHUB_OUTPUT"
          fi

      - name: Compute changed markdown files (push)
        if: ${{ github.event_name == 'push' }}
        id: md_changed_push
        run: |
          set -euo pipefail
          # For pushes, compare with the previous commit
          HEAD_SHA="${{ github.sha }}"
          PREV_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          if [[ -z "$PREV_SHA" ]]; then
            # First commit, skip linting
            echo "has_md_changes=false" >> "$GITHUB_OUTPUT"
            printf "files=\n" >> "$GITHUB_OUTPUT"
          else
            mapfile -t FILES < <(git diff --name-only "$PREV_SHA" "$HEAD_SHA" -- '**/*.md')
            if (( ${#FILES[@]} == 0 )); then
              echo "has_md_changes=false" >> "$GITHUB_OUTPUT"
              printf "files=\n" >> "$GITHUB_OUTPUT"
            else
              echo "has_md_changes=true" >> "$GITHUB_OUTPUT"
              printf "files=%s\n" "${FILES[*]}" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Markdown Lint (push changed only)
        if: ${{ github.event_name == 'push' && steps.md_changed_push.outputs.has_md_changes == 'true' }}
        run: |
          set -euo pipefail
          read -r -a FILES <<< "${{ steps.md_changed_push.outputs.files }}"
          echo "Linting changed Markdown files: ${FILES[*]}"
          npx --yes markdownlint-cli2 "${FILES[@]}"

      - name: Markdown Lint (full)
        if: ${{ false }}
        run: |
          npx --yes markdownlint-cli2 "**/*.md" "#node_modules" "#.git"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install rdflib
        run: |
          python -m pip install --upgrade pip
          pip install rdflib

      - name: Turtle Lint
        run: |
          python tools/lint_ttl.py
